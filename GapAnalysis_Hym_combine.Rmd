---
title: "Gap Analysis Hymenoptera Combined datasets"
author: "Kylie Etter"
date: "7/8/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
This R Code is for data analysis of the Hymenoptera for the TNC Gap Analysis. It downloads the cleaned datasets to combine that have (source, month_arabic, day_arabic, year, island, order, bee, family, genera, specificEp, scientificName) columns. Once combined can compare numbers between sources, compare locality and temporal information. 

The iNaturalist data was removed from the Cal-IBIS data so there was no duplication. 

# Download datasets. (iNaturalist, LACM, Cal-IBIS, Bohart)
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load packages
library(tidyverse)
library(lubridate)


inat =read.csv("~/gitit/TNC Gap Analysis/hym_inat_clean.csv")
lacm = read.csv("~/gitit/TNC Gap Analysis/hym_lacm_clean.csv")
chis = read_csv("~/gitit/TNC Gap Analysis/hym_chis_clean.csv")
bohart = read.csv("~/gitit/TNC Gap Analysis/hym_bohart_clean.csv")

```

#Clean up datasets and combine 

Combine datasets with the specific columns (source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName). 

First, removing excess columns from datasets.

```{r clean up datasets}
inat_column <- inat %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName)
lacm_column <- lacm %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName) 
chis_column <- chis %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName) %>%
filter(!is.na(source))
bohart_column <- bohart %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName)

```

Make master dataset.
Now to combine. iNat = 1372, LACM = 1186, CHIS = 7621, Bohart = 6326 (bohart is all bees). 16505 total. 

```{r create the master }
masterdata = rbind(inat_column, lacm_column, chis_column, bohart_column)
write.csv(masterdata, "hym_master.csv")
```

Updated master dataset with the synonymy. 
```{r}
mastersyn = read.csv("~/gitit/TNC Gap Analysis/hym_master_syn.csv")

```


#Quick and dirty summary stats
Now all 4 data sets are combine! Summary stats here we go! 

```{r master summary}
x= table(masterdata$order)
x
table(masterdata$family)
sum(is.na(masterdata$family))
sum(is.na(masterdata$genus))
sum(is.na(masterdata$specificEp))

colSums(is.na(masterdata))

```
Summary of taxonomic resolution by source 
```{r summary by data source}
table(inat_column$order)
table(inat_column$family)
x = table(inat_column$family)
print(x)

table(chis_column$family)

table(bohart_column$family)

table(lacm_column$family)

table(masterdata$family)


write.csv(masterdata, "gapan_alldata.csv")

```

#Graphs of the different data. 

Mapping the sampling on different islands by data source.
```{r Graphing by island}
library(ggplot2)
 
y= ggplot(masterdata, aes(x=island, fill=source)) + geom_bar(position="fill")
y

r = ggplot(masterdata, aes(x=year, fill=source)) + geom_bar(position="fill")
r

masterdataisland <- masterdata %>% filter(!is.na(island))
masterdataisland <- masterdataisland[c(1:1371, 1373:16366),]

islandplot = ggplot(data = masterdataisland, aes(x = island, fill=source)) + geom_bar()
islandplot = islandplot + theme_classic() + labs(x="Island", y= "Number of Specimen Collected")
qw = islandplot +  stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=1), colour="black")

islandplot2 = ggplot(data = masterdataisland, aes(x = island, fill = source)) +
    geom_bar(position = "dodge")
islandplot2 = islandplot2 + theme_classic() + labs(x="Island", y= "Number of Specimen Collected")
wq = islandplot2 + stat_count(geom = "text", 
             aes(label = stat(count)),
             position= "dodge", colour="black")

islandall = ggplot(data = masterdataisland, aes(x=island)) + geom_bar()
islandall = islandall + stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=0.5), colour="black")
islandall + theme_classic()



```
# With the Synonymy done 
```{r}

mastersynisland <- mastersyn %>% filter(!is.na(island))
mastersynisland <- mastersynisland[c(1:1371, 1373:16366),]

islandplot = ggplot(data = mastersynisland, aes(x = fct_infreq(island), fill=source)) + geom_bar()
islandplot = islandplot + theme_bw() + labs(x="Island", y= "Number of Specimen Collected") 
islandplot + coord_flip() + scale_y_continuous(limits = c(0, 10200), expand=c(0,0))
islandplot + scale_y_continuous(limits = c(0, 10200), expand=c(0,0))

qw = islandplot +  stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=1), colour="black")

islandplot2 = ggplot(data = mastersynisland, aes(x = island, fill = source)) +
    geom_bar(position = "dodge")
islandplot2 = islandplot2 + theme_classic() + labs(x="Island", y= "Number of Specimen Collected")
wq = islandplot2 + stat_count(geom = "text", 
             aes(label = stat(count)),
             position= "dodge", colour="black")

islandall = ggplot(data = mastersynisland, aes(x=island)) + geom_bar()
islandall = islandall + stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=0.5), colour="black")
islandall + theme_classic()


```


Graphing the temporal gaps in collections 
```{r Graphing by year}
yearplot = ggplot(masterdata, aes(x=year, fill=source)) + geom_bar()
yearplot = yearplot + theme_classic() + labs(x="Year", y ="Number of Specimen Collected")
yearplot

yearplot2 = ggplot(masterdata, aes(x=year, fill=source)) + geom_bar(position="dodge")
yearplot2 = yearplot2 + theme_classic() + labs(x="Year", y ="Number of Specimen Collected")
yearplot2
```

Graphing the seasonal gaps in collections. 

```{r Graphing by month}
monthplot = ggplot(masterdata, aes(x=month_arabic, fill=source)) + geom_bar() + scale_x_continuous(breaks = seq(1, 12, by=1)) 
monthplot = monthplot + theme_classic() + (labs(x="Month", y="Number of Specimen Collected")) + scale_x_continuous(breaks = seq(1,12, by=1))
monthplot

monthplotall = ggplot(masterdata, aes(x=month_arabic)) + geom_bar()
monthplotall = monthplotall + theme_classic() + (labs(x="Month", y="Number of Specimen Collected")) + scale_x_continuous(breaks = seq(1, 12, by=1)) 
zx = monthplotall + stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=0.5), colour="black")

```

# Unique values by datasource. Playing aroudn with different ways to do it.
```{r}
library(plyr)
ddply(mastersyn,~source,summarize,number_of_distint_fam=length(unique(family)))

ddply(mastersyn,~source,summarize,number_of_disitinct_gen=length(unique(genus)))
ddply(mastersyn,~record,summarize,number_of_disitinct_gen=length(unique(genus)))

ddply(mastersyn,~source,summarize,number_of_disitinct_gen=length(unique(acceptedScientificName)))
ddply(mastersyn,~record,summarize,number_of_disitinct_gen=length(unique(acceptedScientificName)))

chis_fam = unique(c(as.character(chis$family)))
unique_family =as.data.frame(chis_fam)
bohart_fam = unique(c(as.character(bohart$family)))
bohart_fam


```

 
# Playing around with pie graphs!!!
```{r}
#this didn't work 
ggplot(masterdata ,aes(x = genus, fill=genus)) + geom_bar(width =
1) + coord_polar (theta="y")

#removing NAs from graph
mastersyn_graph <- mastersyn %>%
 na.omit(mastersyn$family)
mastersyn_graph = mastersyn_graph %>% arrange(family)
mastersyn_graph = mastersyn_graph[c(580:16131), ]

bar_occurence <- ggplot(data = mastersyn_graph) + 
  geom_bar(
    mapping = aes(x = fct_infreq(family), fill = family), 
    show.legend = FALSE,
    width = 1
  ) + 
  theme(aspect.ratio = 1) 



bar_occurence = bar_occurence + coord_flip() + labs(x="Family", y= "") + scale_y_continuous(expand=c(0,0))



bar_chis <- ggplot(data = chis) + 
  geom_bar(
    mapping = aes(x = fct_infreq(family), fill = family), 
    show.legend = FALSE,
    width = 1
  ) + 
  theme(aspect.ratio = 1) 

bar_chis = bar_chis + coord_flip() + labs(x="Family", y= "") + scale_y_continuous(expand=c(0,0))

bar_inat <- ggplot(data = inat) + 
  geom_bar(
    mapping = aes(x = fct_infreq(family), fill = family), 
    show.legend = FALSE,
    width = 1) + theme(aspect.ratio = 1)


bar_inat = bar_inat + coord_flip() + labs(x="Family", y= "") + scale_y_continuous(expand=c(0,0))
bar_occurence
bar_chis
bar_inat
library(gridExtra)
grid.arrange(bar_chis, bar_inat) 

```

# Adding and cleaning up the Miller literature database 
```{r}
lit_miller = read.csv("~/gitit/TNC Gap Analysis/Miller_lit.csv")
lit_miller_clean <- lit_miller %>%
  rename(order = ORDER, family = FAMILY, genus = GENUS, specificEp = SPECIES, yearpub = YRPUBL, year = YRCOLL, month = MONTH ) %>%
   select(order, family, genus, specificEp, yearpub, PUBL, year, month, ANA, BAR, CAT, CLE, CRU, MIG, NIC, ROS)

write.csv(lit_miller_clean, "lit_miller_clean.csv")
# going to manually create in Excel Hymenoptera dataframe and add source = lit 

#upload hymenoptera only
# I changed the x to 1s for islands to make a matrix, and then removed any "?" from the islands, so only inlcuding ones that had 1 or nothing, no uncertain ones, for nosp removed the sp. from the species column and any question ones, also split into genus and subgenus columns 
lit_miller_hym = read.csv("~/gitit/TNC Gap Analysis/lit_miller_hym.csv")
lit_miller_hym2 = read.csv("~/gitit/TNC Gap Analysis/lit_miller_hym_nosp.csv")

ddply(lit_miller_hym,~source,summarize,number_of_distint_fam=length(unique(family)))

ddply(lit_miller_hym2,~source,summarize,number_of_disitinct_gen=length(unique(genus)))

ddply(lit_miller_hym2,~source,summarize,number_of_disitinct_gen=length(unique(scientificName)))

unique(c(as.character(lit_miller_hym2$family)))
occgen = unique(c(as.character(mastersyn$acceptedGenus)))
litgen = unique(c(as.character(lit_miller_hym2$genus)))
diffgen = setdiff(litgen, occgen)
diffgen
litgen

unique(c(as.character(mastersyn$genus)))
# 27 fam, 167 genera, *** didn't do good syn 377 unique sp. identified (only included things with a sp. id)
```

#Creating plots based on the Miller database compared to Occurence data, also updated Occurence Temporal plots. 

```{r}
lit = lit_miller_hym2 %>%
 select(record, source, family, genus, specificEp, year, month)
occurence = mastersyn %>%
  rename(month = month_arabic) %>%
  select(record, source, family, genus, specificEp, year, month)
litocc_data= rbind(lit, occurence)



litoccyear = ggplot(litocc_data, aes(x=year, fill=source)) + geom_bar() + theme_bw()
litocc + scale_y_continuous(expand=c(0,0)) + labs(x="Year")

lityear = ggplot(lit, aes(x=year)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Year", y ="")
lityear

occyear = ggplot(mastersyn, aes(x=year, fill=source)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Year", y ="Number of Specimen Collected")
occyear

litoccmonth = ggplot(litocc_data, aes(x=month, fill=source)) + geom_bar() + theme_bw()
litoccmonth + scale_y_continuous(expand=c(0,0)) + labs(x="Month")

litmonth = ggplot(lit, aes(x=month)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Month", y ="")
litmonth = litmonth + scale_x_continuous(breaks = seq(1, 12, by=1)) 
litmonth

occmonth = ggplot(mastersyn, aes(x=month_arabic, fill=source)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Month", y ="Number of Specimen Collected") 
occmonth = occmonth + scale_x_continuous(breaks = seq(1, 12, by=1)) 
occmonth
```

#New Island plots 
```{r}
fct_infreq(family)
islandplot = ggplot(data = masterdataisland, aes(x = island, fill=source)) + geom_bar()
islandplot = islandplot + theme_classic() + labs(x="Island", y= "Number of Specimen Collected")
qw = islandplot +  stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=1), colour="black")
```


