---
title: "Plants_Analysis"
author: "Josie Lesage"
date: "8/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### --- Load Packages --- ###
library(tidyverse)
library(raster)
library(sf)
library(rgdal)
library(raster)
library(rgeos)
library(CoordinateCleaner)
library(scrubr)
library(scales)

### --- Set functions for code --- ###
makeAccum <- function(x,ci,nm){
	# k is the island from isl.names
	# ci is 'r' (raw) or 's' (smooth) for plotting the 90%CI
  resampling.result<-matrix(nrow=length(x),ncol=100)
  for(i in 1:100){
    randCurve<-sample(x,length(x),replace=F)
    for(j in 1:length(x)){
      resampling.result[j,i]<-length(unique(randCurve[1:j]))
    }
  }

# generate raw 90% & 10% CIs
curve.mean <- apply(resampling.result, MARGIN=1,mean)
lowerCI <- apply(resampling.result, MARGIN=1,function(y) {sort(y,decreasing=T)[90]})
upperCI <- apply(resampling.result, MARGIN=1,function(z) {sort(z,decreasing=T)[10]})

#make smoother CIs
# plot curve with smoothed 90% CIs
xlen<-1:length(x)
lowerCIsm<-loess(lowerCI~xlen)
upperCIsm<-loess(upperCI~xlen)

# Plot
plot(0,0,col=0,
     xlim=c(1,length(x)),ylim=c(1,length(unique(x))),
     ylab="Richness",xlab="Number of collections",asp=2)	
if(ci=='s'){
  polygon(c(xlen,rev(xlen)),
          c(lowerCIsm[[2]],rev(upperCIsm[[2]])),col="grey90",border=0)}
if(ci=='r'){
  polygon(c(xlen,rev(xlen)),
          c(lowerCI,rev(upperCI)),col="grey90",border=0)}	
lines(1:length(x),curve.mean)
text(0,length(unique(x)),labels=nm,adj=0,cex=1.5)
}

```

```{r import data}
data <- read_csv("Josie/Data/DraftData_20210823.csv")
```

# File Goal

To use the plant data to produce an analysis of where on the islands plants have been sampled, and where the obvious gaps are. 

# Summaries and Barcharts

# Island heat map
```{r}

# create a dataframe of all complete cases of name, lat/long, island, and year
all_data <- data %>%
  filter(institutionCode != "iNaturalist") %>%
  dplyr::select(Sci_Name, isl_name, decimalLatitude, decimalLongitude, year) %>%
  rename(Latitude = decimalLatitude,
         Longitude = decimalLongitude) %>%
  filter(!is.na(Latitude), !is.na(Longitude))

############### drop points with meaningless coords - this removes any specimens that have long/lats that are not in the vicinity of the islands

########## Remove obvious georeferencing errors by hand- the 'identify' function allows you to click on a scatterplot (ie distribution map) to identify individual points. This is nice if you have a few coords out in the ocean. If you have a bunch, you'll probably want to do an intersection with island polygons, but I didn't have an island polygon file when I was doing this (the maps I used are line shapefiles, not polygons)

## JL: will do this with the coord cleaner package 

flags <- clean_coordinates(x = all_data, lon = "Longitude", lat = "Latitude",
                          species = "Sci_Name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                     "zeros"))
all_data <- all_data[flags$.summary,] 

all_data_coords <- all_data %>%
  filter(Longitude <= -118, Longitude >= -120.5,
         Latitude <= 34.1, Latitude >= 32.7)
  
plot(all_data_coords$Longitude, all_data_coords$Latitude, asp=1)

# using Ben's modified code and a shapefile found online to isolate counties of interest, 
# Albers projection is used in order to have grids in km^2

ibis <- st_read("Heatmap_files/Master_IslandNames.shp")
chis_ibis <- ibis %>%
  filter(Name %in% c("Santa Rosa", "Santa Cruz", "San Miguel", "Anacapa", "San Clemente", "Santa Barbara", "Santa Catalina", "San Nicolas"))

ggplot(chis_ibis) +
  geom_sf()

counties <- readOGR("Heatmap_files", layer="cnty24k09_1_line")
chis_counties<-counties[counties$NAME%in%c("Ventura", "Santa Barbara","Los Angeles","San Diego","Orange")]
is.map<-crop(counties, extent(-1.5e+05,2.5e+05,-6e+05,-4e+05))

plot(is.map, col="black")
rm(counties)
rm(chis_counties)

####### project long lat coords into Albers (island maps are in Albers)
P4S.latlon <- CRS("+proj=longlat +datum=WGS84")
new_proj <- "+proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

sp <- SpatialPointsDataFrame(coords = cbind(as.numeric(all_data_coords$Longitude),
                                            as.numeric(all_data_coords$Latitude)),
                           data = all_data_coords, proj4string = P4S.latlon)
pointsX <- spTransform(sp, CRS(new_proj))

# attach projected points to 'all_data'
all_data_coords <- cbind(all_data_coords,pointsX@coords)


plot(is.map, col="gray50") +
  points(all_data_coords$coords.x1, all_data_coords$coords.x2, cex=.3) 

write_csv(all_data_coords, "Josie/Data/DraftData_Cleaner.csv")

```



```{r accumulation curves and grid}
###### Load data

# 2 col matrix indicating which cells from islandRaster correspond to which island
island.cells<-read.csv("Heatmap_files/islandCells.csv")

# binary raster of the islands and coastline
isl.rast<-raster("Heatmap_files/islandRaster.asc")

# the cleaned specimen data
occ <- read_csv("Josie/Data/DraftData_Cleaner.csv")

# the xlim & ylim (in albers) for plotting each island
plot.lims <- read.csv("Heatmap_files/islandPlotLimits.csv")

isl.names <- c("Anacapa","Santa Cruz","Santa Rosa","San Miguel",
"Santa Catalina","San Clemente","San Nicolas","Santa Barbara")


################ Accumulation curves ################################
# for makeAccum, x = binomials for all specimens from an island, 
#                ci =c('r','s') for plotting smooth or rough 90% Confidence Intervals

# make Accum is a custom function that is defined at the bottom of this file

# k is a number 1:8 corresponding to isl.names (line 22)
k=1
makeAccum(occ$Sci_Name[occ$isl_name==isl.names[k]],'r',nm=isl.names[k])

######### combined accumulation curve plot
plot(0, 0, col=0, xlim=c(0,10000), ylim=c(0,650),
     ylab="Richness", xlab="Number of collections")
for(k in 1:8) {
	x <- occ$Sci_Name[occ$isl_name == isl.names[k]]
	resampling.result <- matrix(nrow=length(x), ncol=100)
	for(i in 1:100){randCurve <- sample(x, length(x), replace=F)
	for(j in 1:length(x)){resampling.result[j,i]<-	
			length(unique(randCurve[1:j]))}}
	# generate raw 90% & 10% CIs
	curve.mean <- apply(resampling.result, MARGIN=1, mean)
	lowerCI <- apply(resampling.result, MARGIN=1, function(y) 
		{sort(y,decreasing=T)[90]})
	upperCI <- apply(resampling.result, MARGIN=1, function(z) 
		{sort(z,decreasing=T)[10]})
	xlen <- 1:length(x)
	lowerCIsm <- loess(lowerCI~xlen)
	upperCIsm <- loess(upperCI~xlen)
	polygon(c(xlen,rev(xlen)),
	c(lowerCI,rev(upperCI)),col="grey90",border=0)	
	lines(1:length(x),curve.mean,col=k)
}
legend("bottomright", legend=isl.names[1:8], 
       lty=1, col=c(1:8))

####### end combined accumulation curve

################# Grid maps ############

# get cellIDs for each occurrence
cellID <- cellFromXY(isl.rast,cbind(occ$coords.x1, occ$coords.x2))
occ <- cbind(occ,cellID); rm(cellID)
length(unique(occ$cellID))

# make a big grid
w <- which(!is.na(isl.rast[]))
taxa <- sort(unique(occ$binom))
taxGrid <- matrix(nrow=length(taxa),ncol=length(w))
colnames(taxGrid) <- w
rownames(taxGrid) <- taxa
taxGrid[] <- 0

for(i in 1:dim(taxGrid)[1]){
	spCells <- occ$cellID[occ$binom==taxa[i]]
	for(j in 1:length(spCells)){
		taxGrid[i,w %in% spCells[j]]<-taxGrid[i,w %in% spCells[j]]+1
	}
}

# make a binary version (this is presence/abs of each sp in each cell rather than num of collections of each sp in each cell)
binaryGrid <- taxGrid
binaryGrid[binaryGrid>0] <- 1

# make corresponding rasters
rich.rast <- isl.rast
rich.rast[rich.rast==1] <- 0
rich.rast[w] <- colSums(binaryGrid)
coll.rast <- isl.rast
coll.rast[coll.rast==1] <- 0
coll.rast[w] <- colSums(taxGrid)

plot(rich.rast)
plot(coll.rast)

################# Calculate %empty and redundacy for islands ##
k=1
is.cel <- island.cells$isl.rastCell[island.cells$island==isl.names[k]]
rich.cel <- rich.rast[is.cel]
coll.cel <- coll.rast[is.cel]

coll.Summary <- matrix(nrow=8,ncol=9)
# Red=  1-R/N
rownames(coll.Summary) <- isl.names
colnames(coll.Summary) <- c("totCells","totColls","totRich","Empty","perEmpty",
"mnRich","mnColl","mnRedund","mnRedundwE")
for(i in 1:7){
	is.cel <- island.cells$isl.rastCell[island.cells$island == isl.names[i]]
	rich.cel <- rich.rast[is.cel]
	coll.cel <- coll.rast[is.cel]
	coll.Summary[i, "totCells"] <- length(rich.cel)
	coll.Summary[i, "totColls"] <- sum(coll.cel)
	coll.Summary[i, "Empty"]<-length(which(rich.cel==0))
	coll.Summary[i, "perEmpty"] <- round(length(which(rich.cel==0))/ 
		length(rich.cel),3)
	coll.Summary[i, "mnRich"] <- mean(rich.cel[rich.cel!=0])
	coll.Summary[i, "mnColl"] <- mean(coll.cel[rich.cel!=0])
	coll.Summary[i, "totRich"] <- length(unique( 
		occ$binom[occ$island==isl.names[i]]))
	coll.Summary[i,"mnRedund"] <- round(mean(1-(rich.cel[rich.cel!=0]/coll.cel[rich.cel!=0])),3)
	# coll.Summary[i,"mnRedundwE"] <- round(1/mean((coll.cel-
	# 	rich.cel)),3)
}

######### Make Grid-based maps ##################
colorfunc<-colorRampPalette(c("white","dodgerblue"))
colRamp<-colorfunc(20)

# richness
i=1
plot(rich.rast,col=colRamp,xlim=c(plot.lims[i,1]))
```

```{r basic graphs}

occ <- occ %>%
  filter(year > 1800)

plants_islandsum <- occ %>%
  mutate(no_sample = 1) %>%
  group_by(isl_name, year) %>%
  summarise(samples = sum(no_sample))

plants_island_time <- ggplot(data = plants_islandsum, aes(y = samples, x = year, fill = isl_name)) + 
  annotation_logticks() +
  geom_bar(stat = "identity") +
  labs(x ="Year", 
       y = "Number of Specimens Collected",
       fill = "Island") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0.5, vjust = 0.25),
        legend.position = "none",
        strip.background = element_rect(fill = "white")) +
  scale_y_log10(breaks = log_breaks(), expand = c(0,0)) +
  scale_x_continuous(limits = c(1850,2025), expand = c(0,0)) +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~isl_name, ncol = 4)

ggplot(data = plants_islandsum, aes(y = samples, x = year, fill = isl_name)) + 
  geom_bar(stat = "identity") +
  labs(x ="Year", 
       y = "Number of Specimens Collected",
       fill = "Island") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0.5, vjust = 0.25),
        legend.position = "none",
        strip.background = element_rect(fill = "white")) +
  scale_y_continuous(limits = c(0,1500), expand = c(0,0)) +
  scale_x_continuous(limits = c(1850,2025), expand = c(0,0)) +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~isl_name, ncol = 4)

plants_island_time

ggsave(plants_island_time, filename = "Josie/Figures_Spec_Isl_Time", height = 1800, width = 2400, units = "px", dpi = 300)


```

