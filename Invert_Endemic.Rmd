---
title: "Invert_Endemics"
author: "Kylie Etter"
date: "9/27/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This is a R Markdown to make graphs for the Channel Islands endemic invertebrates for the TNC Gap Analysis. The master occurrence data files were made in "Invert_Code.Rmd" from the various sources per taxa and then saved to the project. I am using the master master data file created for this code. To do:aran, C3,C4,C8,C5,C7,C9,dipt,hemi,bee,wasp,ant,diplo,L1,L4,butt&skip,L6,L7,opil,grass,crick,phas,scor,moll1,moll2,moll3,moll4

Shifting gears not making this smaller tables for each endemic but will make a nice table for all of them documenting what islands they are known to be on and what we actually see in the data, totalling the number in the occurrence data and adding the last date collected.

#Making a nice table 
```{r Added the occurence counts to the list}
invert_end_list = read_csv("endemics/invert_endemic_list1_clean.csv")

invertcount_occ = table(invert_end_join$acceptedName)
invertcount_occ = as.data.frame.table(invertcount_occ) %>%
  rename(Occurence= "Freq",  acceptedName = "Var1")

invert_end_list2 = left_join(invert_end_list, invertcount_occ)
write_csv(invert_end_list2, "endemics/invert_endemic_list2.csv", na="")

```

```{r Occurence data islands adding to matrix}
master_inverts <-read_csv("master/master_inverts2.csv")
invert_end <-read_csv("endemics/invert_endemic_list2.csv")
invert_end_cut <- invert_end %>%
  select(acceptedName, commonName, Endemic)

invert_end_join <- inner_join(master_inverts, invert_end, by="acceptedName") %>% 
  select(source, island, year, acceptedName) 

in_end_compress <- invert_end_join %>%
  mutate(no_sample = 1) %>%
  group_by(acceptedName, island) %>%
  summarise(samples = sum(no_sample))

library(data.table)
in_end_matrix <- in_end_compress %>% spread(island, samples)

in_end_year <- invert_end_join %>% group_by(acceptedName) %>% summarise(max_year=max(year, na.rm=TRUE))

in_end_matyr = left_join(in_end_matrix, in_end_year) %>%
  rename(year="max_year")

in_end_table = left_join(in_end_matyr, invert_end_join)
  
in_end_table_distinct = distinct(in_end_table, acceptedName, .keep_all=TRUE)

invert_end_complete = left_join(invert_end, in_end_table_distinct)

write.csv(invert_end_complete, "endemics/invert_end_complete.csv", na="")

```


#First Pass Endemic..not using
##Download data
```{r Endemic List}
invert_end <- read_csv("invert_endemic2.csv") %>%
  rename(endemic_source = "source", islands="Island(s)")
```
```{r Master Taxa Data}
master_inverts <-read_csv("master/master_inverts2.csv")
```

##Join endemic data to master data
```{r join data}
invert_end_join = inner_join(master_inverts, invert_end, by="acceptedName")

#Looking at what is on the endemic list but not in our data 
invertdata = unique(c(as.character(invert_end_join$acceptedName)))
invertend = unique(c(as.character(invert_end$acceptedName)))
invertdiff = setdiff(invertend, invertdata)
invertdiff = as.data.frame(invertdiff) %>% 
  rename(acceptedName="invertdiff")
invertdiff2 = left_join(invertdiff, invert_end)

#81 not in our data....

#updating synonymy for invert_end with synonymy list created from masters, and creating csv of result to go through unsyn and eliminate or write in synonymy that I will then use to update the synonymy list / confirm really not in our data
master_invert_syn = read_Csv("master/master_invert_syn.csv")
invert_end = invert_end %>% rename(scientificName = "acceptedName")
invert_end_syn = left_join(invert_end, master_invert_syn)
write_csv(invert_end_syn, "invert_end_syn.csv", na="")
```



##Arachnida 
```{r Acari}
arac_end = filter(invert_end_join, group_forR=="aran")
arac_islandsum <- arac_end %>%
  mutate(no_sample = 1) %>%
  group_by(island, acceptedName, source) %>%
  summarise(samples = sum(no_sample))

a_m_islandsum2 <- na.omit(subset(aves_m_islandsum, select = c(island, samples, source2, acceptedName)))

island_size = read_csv("island_size.csv")
arac_islandsum2 = merge(arac_islandsum, island_size, by="island", all.y=TRUE) 

x= c("#D95F02")

#replaced NAs in acceptedName with one of the species so an NA graph doesn't appear, but doesn't impact other graphs at all
arac_islandsum2$acceptedName[is.na(arac_islandsum2$acceptedName)] <- "Lutica nicolasia"

arac_island <- ggplot(data = arac_islandsum2, aes(x = samples, y = fct_rev(island), fill=source)) + geom_bar(stat = "identity") + facet_wrap(vars(acceptedName), ncol=2, scales="free_x") +
  labs(y ="Island",  x = "Number of Data Points", fill = "Data Source") + theme_bw() + scale_fill_manual(values=x) + scale_x_continuous(expand=expansion(mult=c(0,0.05))) + theme(axis.text = element_text(size = 8), axis.title = element_text(size=15), strip.text = element_text(size=14), legend.text = element_text(size=12)) 

arac_island

ggsave(plot=arac_island, filename="endemics/InvertGraphs/arac_island.png", height=10, width=35, units="cm", dpi=300)
```

##Coleoptera
##C5
```{r}
#brewer.pal(5, name="Dark2") Color codes for the brewer colors, need 1, 2 and 4 for this one
#Cal-IBIS "#1B9E77"            iNaturalist "#D95F02"            EBIRD #7570B3"
#SBMNH Col "#E7298A"            SBMNH Obs "#7FBC41"

col5_end = filter(invert_end_join, group_forR=="C5")
col5_islandsum <- col5_end %>%
  mutate(no_sample = 1) %>%
  group_by(island, acceptedName, source) %>%
  summarise(samples = sum(no_sample))



island_size = read_csv("island_size.csv")
col5_islandsum2 = merge(col5_islandsum, island_size, by="island", all.y=TRUE) 

x= c("#1B9E77", "#7570B3")

#replaced NAs in acceptedName with one of the species so an NA graph doesn't appear, but doesn't impact other graphs at all
col5_islandsum2$acceptedName[is.na(col5_islandsum2$acceptedName)] <- "Serica cruzi"

col5_island <- ggplot(data = col5_islandsum2, aes(x = samples, y = fct_rev(island), fill=source)) + geom_bar(stat = "identity") + facet_wrap(vars(acceptedName), ncol=2, scales="free_x") +
  labs(y ="Island",  x = "Number of Data Points", fill = "Data Source") + theme_bw() + scale_fill_manual(values=x) + scale_x_continuous(expand=expansion(mult=c(0,0.05))) + theme(axis.text = element_text(size = 8), axis.title = element_text(size=15), strip.text = element_text(size=14), legend.text = element_text(size=12)) 

col5_island

ggsave(plot=col5_island, filename="endemics/InvertGraphs/col5_island.png", height=20, width=35, units="cm", dpi=300)
```
##C7
```{r}
#brewer.pal(5, name="Dark2") Color codes for the brewer colors, need 1, 2 and 4 for this one
#Cal-IBIS "#1B9E77"            iNaturalist "#D95F02"            EBIRD #7570B3"
#SBMNH Col "#E7298A"            SBMNH Obs "#7FBC41"

col7_end = filter(invert_end_join, group_forR=="C7")
col7_islandsum <- col7_end %>%
  mutate(no_sample = 1) %>%
  group_by(island, acceptedName, source) %>%
  summarise(samples = sum(no_sample))



island_size = read_csv("island_size.csv")
col7_islandsum2 = merge(col7_islandsum, island_size, by="island", all.y=TRUE) 

x= c("#1B9E77", "#D95F02", "#7570B3")

#replaced NAs in acceptedName with one of the species so an NA graph doesn't appear, but doesn't impact other graphs at all
col7_islandsum2$acceptedName[is.na(col7_islandsum2$acceptedName)] <- "Coenonycha fulva"

col7_island <- ggplot(data = col7_islandsum2, aes(x = samples, y = fct_rev(island), fill=source)) + geom_bar(stat = "identity") + facet_wrap(vars(acceptedName), ncol=2, scales="free_x") +
  labs(y ="Island",  x = "Number of Data Points", fill = "Data Source") + theme_bw() + scale_fill_manual(values=x) + scale_x_continuous(expand=expansion(mult=c(0,0.05))) + theme(axis.text = element_text(size = 8), axis.title = element_text(size=15), strip.text = element_text(size=14), legend.text = element_text(size=12)) 

col7_island

ggsave(plot=col7_island, filename="endemics/InvertGraphs/col7_island.png", height=20, width=35, units="cm", dpi=300)
```


