---
title: "Gap Analysis Hymenoptera Combined datasets"
author: "Kylie Etter"
date: "7/8/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
This R Code is for graphing the Hymenoptera trends for the TNC Gap Analysis. It downloads the cleaned datasets to combine that have (source, month_arabic, day_arabic, year, island, order, bee, family, genera, specificEp, scientificName) columns. 

The iNaturalist data was removed from the Cal-IBIS data so there was no duplication. 



# Step 1. Download datasets. 
(iNaturalist, LACM, Cal-IBIS, Bohart for Hymenoptera)
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load packages
library(tidyverse)
library(lubridate)
library(ggplot2)
library(plyr)
library(dplyr)

inat =read.csv("hymenoptera/hym_inat_clean.csv")
lacm = read.csv("hymenoptera/hym_lacm_clean.csv")
chis = read_csv("hymenoptera/hym_chis_clean.csv")
bohart = read.csv("hymenoptera/hym_bohart_clean.csv")
bold = read.csv("hymenoptera/BOLD_IslandHymenoptera_Feb2021.csv")
```

# Step 2. Clean up datasets

Combine datasets with the specific columns (source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName). 

 ** NOTE I DID SYNONYMY AFTER COMBINING THE DATASETS, if done before include acceptedFamily, acceptedGenus, acceptedEpithet, and accepetedName or the syntax you used for these columns in the code below. 

First, removing excess columns from datasets. Will be different for all other Orders (names of columns are different and using synonymy columns)

```{r clean up datasets}
inat_column <- inat %>%
  select(source, month, day_arabic, year, island, order, family, genus, specificEp, scientificName)
lacm_column <- lacm %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName) 
chis_column <- chis %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName) %>%
filter(!is.na(source))
bohart_column <- bohart %>%
  select(source, month_arabic, day_arabic, year, island, order, family, genus, specificEp, scientificName)

```

# Step 3. Make master dataset.
Now to combine. iNat = 1372, LACM = 1186, CHIS = 7621, Bohart = 6326 (bohart is all bees). 16505 total. 

```{r create the master }
masterdata = rbind(inat_column, lacm_column, chis_column, bohart_column)
write.csv(masterdata, "hym_master.csv")
```
**Ignore if you did synonymy before combining

Updated master dataset with the synonymy. 
```{r synonymy dataset}
mastersyn = read.csv("hymenoptera/hym_master_syn.csv")


```
# Adding the BOLD data to the mastersyn. 
Mastersyn2 documnet has no temporal information
```{r}
bold_column <- bold %>%
  select(record, source, island, acceptedFamily, acceptedGenus, acceptedName)
mastersyn_column <- mastersyn %>%
  select(record, source, island, acceptedFamily, acceptedGenus, acceptedName)
mastersyn2 = rbind(mastersyn_column, bold_column)
```

# Step 4. Graph! 

Graphs of the different data. Didn't use BOLD data because so few, neglagible

## Mapping the sampling on different islands by data source. 
There was a N/A for island that I just removed manually below to make a new dataset for the island graph. 
```{r Graphing by island}
library(ggplot2)
 
mastersynisland <- mastersyn %>% filter(!is.na(island))
mastersynisland <- mastersynisland[c(1:1371, 1373:16366),]

islandplot = ggplot(data = mastersynisland, aes(x = fct_infreq(island), fill=source)) + geom_bar()
islandplot = islandplot + theme_bw() + labs(x="Island", y= "Number of Specimens Sampled") 
islandplot = islandplot + coord_flip() + scale_y_continuous(limits = c(0, 10200), expand=c(0,0))
islandplot

hym_islandsum <- hym_master_syn %>%
  mutate(no_sample = 1) %>%
  group_by(island, source) %>%
  summarise(samples = sum(no_sample))

island_size = read_csv("island_size.csv")
hym_island = merge(hym_islandsum, island_size, by="island", all.y=TRUE)
hym_islandprop = hym_island %>% group_by(island) %>% mutate(by_area = samples/island_size_85)

hym_island_prop <- ggplot(data = hym_islandprop, aes(x = by_area, y = fct_rev(island), fill = source)) + 
  geom_bar(stat = "identity") +
  labs(x ="Island", 
       y = "Number of Specimens Collected Proportional to Island Size",
       fill = "Data Source") +
  theme_bw() + 
  scale_x_continuous(limits =c(0,70), expand = c(0,0)) +
  scale_fill_brewer(palette = "Dark2")

hym_island_prop 

ggsave(plot=hym_island_prop, filename="diptera/DipteraGraphs/hym_island_prop.png", height=5, width=8, units="in", dpi=300)
```

##Graphing the temporal gaps in collections (mastersyb = database)
```{r Graphing by year}

occyear = ggplot(mastersyn, aes(x=year, fill=source)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Year", y ="Number of Specimens Sampled")
occyear

```

##Graphing the seasonal gaps in collections. 

```{r Graphing by month}

occmonth = ggplot(mastersyn, aes(x=month, fill=source)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Month", y ="Number of Specimens Sampled") 
occmonth = occmonth + scale_x_continuous(breaks = seq(1, 12, by=1)) 
occmonth

#by month and island 
mastersyn$month2 = as.factor(mastersyn$month)
mastersyn$Month = mastersyn$month2
hymmonth <- na.omit(subset(mastersyn, select = c(island, Month)))
# weird na so I had to manually remove blank
hymmonth <- hymmonth[c(1:1371, 1373:16323),]
isoccmonth = ggplot(hymmonth, aes(x=Month, fill=Month))+ geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Sampling per Island by Month", y ="Number of Specimens Sampled") +  facet_wrap(vars(island), nrow=2)
isoccmonth 


```


 
## Bar graph comparing families of Hymenoptera 

Playing around with pie graphs!!!
```{r Graphing Families}
#this didn't work 
ggplot(masterdata ,aes(x = genus, fill=genus)) + geom_bar(width =
1) + coord_polar (theta="y")

#removing NAs from graph
mastersyn_graph <- mastersyn %>%
 na.omit(mastersyn$family)
mastersyn_graph = mastersyn_graph %>% arrange(family)
mastersyn_graph = mastersyn_graph[c(580:16131), ]

bar_occurence <- ggplot(data = mastersyn_graph) + 
  geom_bar(
    mapping = aes(x = fct_infreq(family), fill = family), 
    show.legend = FALSE,
    width = 1
  ) + 
  theme(aspect.ratio = 1) 



bar_occurence = bar_occurence + coord_flip() + labs(x="Family", y= "") + scale_y_continuous(expand=c(0,0))



bar_chis <- ggplot(data = chis) + 
  geom_bar(
    mapping = aes(x = fct_infreq(family), fill = family), 
    show.legend = FALSE,
    width = 1
  ) + 
  theme(aspect.ratio = 1) 

bar_chis = bar_chis + coord_flip() + labs(x="Family", y= "") + scale_y_continuous(expand=c(0,0))

bar_inat <- ggplot(data = inat) + 
  geom_bar(
    mapping = aes(x = fct_infreq(family), fill = family), 
    show.legend = FALSE,
    width = 1) + theme(aspect.ratio = 1)


bar_inat = bar_inat + coord_flip() + labs(x="Family", y= "") + scale_y_continuous(expand=c(0,0))
bar_occurence
bar_chis
bar_inat
library(gridExtra)
grid.arrange(bar_chis, bar_inat) 

```

#Step 5. Compare to Literature database 

## Adding and cleaning up the Miller literature database 

I adjusted things in Excel to make it comparable to the occurence data. 
```{r Literature data upload}
lit_miller = read.csv("~/gitit/TNC Gap Analysis/hymenoptera/lit_miller_hym_nosp.csv")
lit_miller_clean <- lit_miller %>%
  rename(order = ORDER, family = FAMILY, genus = GENUS, specificEp = SPECIES, yearpub = YRPUBL, year = YRCOLL, month = MONTH ) %>%
   select(order, family, genus, specificEp, yearpub, PUBL, year, month, ANA, BAR, CAT, CLE, CRU, MIG, NIC, ROS)

write.csv(lit_miller_clean, "lit_miller_clean.csv")
# going to manually create in Excel Hymenoptera dataframe and add source = lit 

#upload hymenoptera only
# I changed the x to 1s for islands to make a matrix, and then removed any "?" from the islands, so only inlcuding ones that had 1 or nothing, no uncertain ones, for nosp removed the sp. from the species column and any question ones, also split into genus and subgenus columns 
lit_miller_hym = read.csv("~/gitit/TNC Gap Analysis/hymenoptera/lit_miller_hym_nosp.csv")

ddply(lit_miller_hym,~source,summarize,number_of_distint_fam=length(unique(acceptedFamily)))

ddply(lit_miller_hym,~source,summarize,number_of_disitinct_gen=length(unique(acceptedGenus)))

ddply(lit_miller_hym,~source,summarize,number_of_disitinct_gen=length(unique(acceptedName)))

unique(c(as.character(lit_miller_hym2$acceptedFamily)))
occgen = unique(c(as.character(mastersyn$acceptedGenus)))
litgen = unique(c(as.character(lit_miller_hym$acceptedGenus)))
diffgen = setdiff(litgen, occgen)
diffgen
litgen
diffgen2 = setdiff(occgen, litgen)
diffgen2

occfam = unique(c(as.character(mastersyn$acceptedFamily)))
litfam = unique(c(as.character(lit_miller_hym2$family)))
difffam = setdiff(occfam, litfam)
difffam

unique(c(as.character(mastersyn$genus)))
# 20 fam, 162 genera, 360
```

Creating plots based on the Miller database compared to Occurence data, 
also combined Occurence and Lit plots that aren't helpful
```{r Literature Graphs}
lit = lit_miller_hym2 %>%
 select(record, source, family, genus, specificEp, year, month)
occurence = mastersyn %>%
  rename() %>%
  select(record, source, family, genus, specificEp, year, month)
litocc_data= rbind(lit, occurence)



litoccyear = ggplot(litocc_data, aes(x=year, fill=source)) + geom_bar() + theme_bw()
litocc + scale_y_continuous(expand=c(0,0)) + labs(x="Year")

lityear = ggplot(lit, aes(x=year)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Year", y ="")
lityear

litoccmonth = ggplot(litocc_data, aes(x=month, fill=source)) + geom_bar() + theme_bw()
litoccmonth + scale_y_continuous(expand=c(0,0)) + labs(x="Month")

litmonth = ggplot(lit, aes(x=month)) + geom_bar() + theme_bw() + scale_y_continuous(expand=c(0,0)) + labs(x="Month", y ="")
litmonth = litmonth + scale_x_continuous(breaks = seq(1, 12, by=1)) 
litmonth


```

Extra code to determine the unqiue values by datasource.

#Unique values by datasource. Playing aroudn with different ways to do it.
```{r Unqiue values by data source code}
library(plyr)
library(dplyr)
ddply(mastersyn2,~source,summarize,number_of_distint_fam=length(unique(acceptedFamily)))

ddply(mastersyn,~source,summarize,number_of_disitinct_gen=length(unique(genus)))
ddply(mastersyn,~record,summarize,number_of_disitinct_gen=length(unique(genus)))

ddply(mastersyn,~source,summarize,number_of_disitinct_gen=length(unique(acceptedScientificName)))
ddply(mastersyn,~record,summarize,number_of_disitinct_gen=length(unique(acceptedScientificName)))

chis_fam = unique(c(as.character(chis$family)))
unique_family =as.data.frame(chis_fam)
bohart_fam = unique(c(as.character(bohart$family)))
bohart_fam


```

Number of unique species per island by occurence data and then literature (miller), Table 2. Stats
```{r}
ddply(mastersyn,~island,summarize,number_of_distinct_fam=length(unique(acceptedFamily)))
hymfam = unique(c(as.character(mastersyn$acceptedFamily)))

ddply(mastersyn,~island,summarize,number_of_distinct_fam=length(unique(acceptedGenus)))
hymgen = unique(c(as.character(mastersyn$acceptedGenus)))

ddply(mastersyn,~island,summarize,number_of_distinct_fam=length(unique(acceptedName)))
hymsp = unique(c(as.character(mastersyn$acceptedName)))


#miller lit 

ddply(lit_miller_hym,~island,summarize,number_of_distinct_fam=length(unique(acceptedFamily)))
hymfam2 = unique(c(as.character(lit_miller_hym2$acceptedFamily)))

ddply(lit_miller_hym,~island,summarize,number_of_distinct_fam=length(unique(acceptedGenus)))
hymgen2 = unique(c(as.character(lit_miller_hym2$acceptedGenus)))

ddply(lit_miller_hym,~island,summarize,number_of_distinct_fam=length(unique(acceptedName)))
hymsp2 = unique(c(as.character(mastersyn$acceptedName)))

```


##Hym Step. 3 Make Graphs! New Standardized code with edits 

### Island Graph 
```{r Graphing by island}

 hym_islandsum <- mastersyn %>%
   mutate(no_sample = 1) %>%
   group_by(island, source) %>%
   summarise(samples = sum(no_sample)) %>%
   filter(!is.na(island)) %>%
   ungroup() %>%
   mutate(source2 = fct_relevel(source, "Cal-IBIS", "iNaturalist", "LACM", "Bohart"))

hym_islandsum = hym_islandsum[c(2:33),] 

hym_island <- ggplot(data = hym_islandsum, aes(x = samples, y = fct_rev(island), fill = source)) + 
  geom_bar(stat = "identity") +
  labs(x ="Island", 
       y = "Number of Hymenoptera Specimens Collected",
       fill = "Data Source") +
  theme_bw() + 
  scale_x_continuous(limits =c(0,11000), expand = c(0,0)) +
  scale_fill_brewer(palette = "Dark2")

hym_island 

ggsave(plot=hym_island, filename="hymenoptera/HymenopteraGraphs/hym_island.png", height=5, width=8, units="in", dpi=300)

```

```{r Graphing by island proportional}
island_size = read_csv("island_size.csv")
hym_islandsum2 = merge(hym_islandsum, island_size, by="island", all.y=TRUE)
hym_islandprop = hym_islandsum2 %>% group_by(island) %>% mutate(by_area = samples/island_size_85)

hym_island_prop <- ggplot(data = hym_islandprop, aes(x = by_area, y = fct_rev(island), fill = source2)) + 
  geom_bar(stat = "identity") +
  labs(x ="Island", 
       y = "Hymenoptera Specimens Collected/Island Area (km^2)",
       fill = "Data Source") +
  theme_bw() + 
  scale_x_continuous(limits =c(0,150), expand = c(0,0)) +
  scale_fill_brewer(palette = "Dark2")

hym_island_prop 

ggsave(plot=hym_island_prop, filename="hymenoptera/HymenopteraGraphs/hym_island_prop.png", height=5, width=8, units="in", dpi=300)
```


### Temporal Graph
```{r Graphing by year}

hymyear =  mastersyn %>% mutate(source2 = fct_relevel(source, "Cal-IBIS", "iNaturalist", "LACM", "Bohart"))

hym_year = ggplot(hymyear, aes(x=year, fill=source2)) + 
  geom_bar() + 
  theme_bw() + 
  scale_y_continuous(expand=c(0,0), limits = c(0, 3500)) + 
  scale_x_continuous(expand=c(0,0), limits=c(1890, 2025), breaks=c(1900, 1915, 1930, 1945, 1960, 1975, 1990, 2005, 2020)) + 
  labs(x="Year", y ="Number of Hymenoptera Specimens Sampled") +   scale_fill_brewer(palette = "Dark2")

hym_year

ggsave(plot=hym_year, filename="hymenoptera/HymenopteraGraphs/hym_year.png", height=5, width=9, units="in", dpi=300)

```

###Graphing the seasonal gaps in collections. 

```{r Graphing by month}
# by month and island 
mastersyn$month <- as.factor(mastersyn$month)
hym_month <- na.omit(subset(mastersyn, select = c(island, month)))
hym_month <- hym_month[c(1:1371, 1373:16323),]

hym_ismonth <- ggplot(hym_month, aes(x=month, fill=month)) + 
  geom_bar() + 
  theme_bw() + 
  scale_y_continuous(expand=c(0,0.5)) + 
  labs(x="Hymenoptera Sampling per Island by Month", y ="Number of Specimens Sampled") +  
  facet_wrap(vars(island), nrow=2, scales="free_y")

hym_ismonth 

ggsave(plot=hym_ismonth, filename="hymenoptera/HymenopteraGraphs/hym_seasonal.png", height=5, width=9, units="in", dpi=300)

```
